<style>
    #empty-row {
        visibility: hidden;
    }
</style>
<div id="datepicker"></div>
<form method="POST" action"">
    {% csrf_token %}
    {{ formset.management_form }}
    <div class='form-row'>
        <!-- {{ form.as_p }} -->
    </div>
    <a class='btn btn-link add-new-form' href='#'>+ Add new form</a>
    <a class='btn btn-link add-new-form' href='#'>+ Add new form test</a>
    <table><tr><td class="add-new-form">Add td test</td></tr></table>
    <input type="submit" value="Create">
</form>

<div class='form-row' id='empty-row'>
    {{ form.empty_form.as_p }}
</div>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="https://code.jquery.com/color/jquery.color-2.1.2.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <link rel="stylesheet" href="/resources/demos/style.css">
<script>
    $( function() {
      $( "#datepicker" ).datepicker({
          beforeShowDay: function() {
              return [true, 'add-new-form']
          }
      });
    } );

    $(document).ready(function() {



        function updateEmptyFormIDs(element, totalForms){
            var thisInput = element
            // get current form input name
            var currentName = element.attr('name')
            // replace "prefix" with actual number
            var newName = currentName.replace(/__prefix__/g, totalForms)
            // console.log(newName)

            // update input with new name
            thisInput.attr('name', newName)
            thisInput.attr('id', "id_" + newName)
            // create a new form row id
            var newFormRow = element.closest(".form-row");
            var newRowId =  "row_id_" + newName
            newFormRow.attr("id", newRowId)
            // add new class for basic graphic animation
            newFormRow.addClass("new-parent-row")
            // update form group id
            var parentDiv = element.parent();
            parentDiv.attr("id", "parent_id_" + newName)
            // update label id
            var inputLabel = parentDiv.find("label")
            inputLabel.attr("for", "id_" + newName)

            // return created row
            return newFormRow
        }
        $('.add-new-form').click(function(e) {
            console.log("clicked");
            e.preventDefault()
            // form id like #id_form-TOTAL_FORMS
            var formId = "id_form-TOTAL_FORMS"
            // copy empty form
            var emptyRow = $("#empty-row").clone();
            // remove id from new form
            emptyRow.attr("id", null)
            // Insert row after last row
            console.log(emptyRow);
            // get starting form count for formset
            var totalForms = parseInt($('#' + formId).val());
            console.log(totalForms)
            // create new form row from empty form row
            var newFormRow;
            emptyRow.find("input").each(function(){
                newFormRow = updateEmptyFormIDs($(this), totalForms)
            })
            // insert new form at the end of the last form row
            $(".form-row:last").after(newFormRow)
            // update total form count (to include new row)
            $('#'+ formId).val(totalForms + 1);
            console.log(newFormRow)
            // scroll page to new row
            /*
            $('html, body').animate({
                scrollTop: newFormRow.offset().top - 100
            }, 500, function(){
                // animate background color
                // requires: jQuery Color: https://code.jquery.com/color/jquery.color-2.1.2.min.js
                newFormRow.animate({
                    backgroundColor: "#fff"
                }, 1500)

            });
            */
        });


    });
</script>
